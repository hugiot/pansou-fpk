#!/bin/bash

# 日志文件
LOG_FILE="${TRIM_PKGVAR}/pansou.log"
# docker-compose.yaml 文件路径
FILE_PATH="${TRIM_PKGINST_TEMP_DIR}/docker/docker-compose.yaml"

# 认证配置
AUTH_ENABLED="$auth_enabled"
AUTH_USERS="$auth_users"
AUTH_TOKEN_EXPIRY="$auth_token_expiry"
AUTH_JWT_SECRET="$auth_jwt_secret"
# 高级配置
PROXY="$proxy"
CACHE_ENABLED="$cache_enabled"
CACHE_TTL="$cache_ttl"
MAX_CONCURRENCY="$max_concurrency"
MAX_PAGES="$max_pages"

log_msg() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') | $1" >> ${LOG_FILE}
}

# 判断文件是否存在
if [ ! -e "$FILE_PATH" ]; then
    log_msg "$FILE_PATH file not exists"
    exit 1
fi

# 输出完整配置
log_msg "----------------------------------------"
log_msg "auth_enabled      : $AUTH_ENABLED"
log_msg "auth_users        : $AUTH_USERS"
log_msg "auth_token_expiry : $AUTH_TOKEN_EXPIRY"
log_msg "auth_jwt_secret   : $AUTH_JWT_SECRET"
log_msg "proxy             : $PROXY"
log_msg "cache_enabled     : $CACHE_ENABLED"
log_msg "cache_ttl         : $CACHE_TTL"
log_msg "max_concurrency   : $MAX_CONCURRENCY"
log_msg "max_pages         : $MAX_PAGES"
log_msg "----------------------------------------"


# 设置认证配置
if [ "$AUTH_ENABLED" = "true" ]; then
    sed -i "s/AUTH_ENABLED=.*$/AUTH_ENABLED=true/g" $FILE_PATH
    sed -i "s/AUTH_USERS=.*$/AUTH_USERS=$AUTH_USERS/g" $FILE_PATH
    sed -i "s/AUTH_TOKEN_EXPIRY=.*$/AUTH_TOKEN_EXPIRY=$AUTH_TOKEN_EXPIRY/g" $FILE_PATH
    sed -i "s/AUTH_JWT_SECRET=.*$/AUTH_JWT_SECRET=$AUTH_JWT_SECRET/g" $FILE_PATH
else
    sed -i "s/AUTH_ENABLED=.*$/AUTH_ENABLED=false/g" $FILE_PATH
fi

# 设置高级配置
if [ -n "$PROXY" ]; then
    sed -i "s/PROXY=.*$/PROXY=$PROXY/g" $FILE_PATH
fi
if [ "$CACHE_ENABLED" = "true" ]; then
    sed -i "s/CACHE_ENABLED=.*$/CACHE_ENABLED=true/g" $FILE_PATH
    sed -i "s/CACHE_TTL=.*$/CACHE_TTL=$CACHE_TTL/g" $FILE_PATH
else
    sed -i "s/CACHE_ENABLED=.*$/CACHE_ENABLED=false/g" $FILE_PATH
fi
if [ -n "$MAX_CONCURRENCY" ]; then
    sed -i "s/MAX_CONCURRENCY=.*$/MAX_CONCURRENCY=$MAX_CONCURRENCY/g" $FILE_PATH
fi
if [ -n "$MAX_PAGES" ]; then
    sed -i "s/MAX_PAGES=.*$/MAX_PAGES=$MAX_PAGES/g" $FILE_PATH
fi

exit 0